// Generated by CoffeeScript 1.10.0
(function(window, $) {
  var MULTIPART, doc, win;
  MULTIPART = 'multipart/form-data';
  win = $(window);
  doc = $(window.document.body);
  $.fn.loading = function() {
    var el;
    el = $(this);
    return el.each(function() {
      el = $(this);
      el.data('loading-orig-html', el.html());
      return el.html($.template('loading'));
    });
  };
  $.fn.cancelLoading = function() {
    var el;
    el = $(this);
    return el.each(function() {
      var origHtml;
      origHtml = el.data('loading-orig-html');
      if (!origHtml) {
        return;
      }
      el.html(origHtml);
      return el.removeData('loading-orig-html');
    });
  };
  $.createSubmitFrame = function(id) {
    var submitFrame;
    submitFrame = $('<iframe></iframe>');
    submitFrame.hide();
    submitFrame.attr('id', id);
    submitFrame.attr('name', id);
    doc.append(submitFrame);
    return submitFrame;
  };
  $.fn.makePartial = function() {
    var el;
    el = $(this);
    return el.append('<input type="hidden" name="partial" value="yes">');
  };
  $.fn.funnelSubmit = function(options) {
    var containerId, el, submitComplete, submitFrame, submitFrameHandler, submitHandler, submitTarget;
    el = $(this);
    containerId = el.attr('id');
    submitTarget = containerId + "-submit-frame";
    submitFrame = $.createSubmitFrame(submitTarget);
    submitComplete = function() {
      if (options && options.onCompleteEvent) {
        return win.trigger(options.onCompleteEvent);
      }
    };
    submitFrameHandler = function(e) {
      el.html((submitFrame.contents().find('body')).html());
      return submitComplete();
    };
    submitHandler = function(e) {
      var action, form, formData, res;
      form = $(this);
      if ((form.attr('enctype')) === MULTIPART) {
        form.makePartial().attr('target', submitTarget);
        return submitFrame.one('load', submitFrameHandler);
      } else {
        e.preventDefault();
        formData = form.serialize();
        action = (form.attr('action')) || window.location.pathname;
        res = $.post(action, formData);
        res.done(function(resp) {
          el.html(resp);
          return submitComplete();
        });
        return res.fail(function(xhr) {
          el.html(xhr.responseText);
          return submitComplete();
        });
      }
    };
    return el.on('submit', 'form', submitHandler);
  };
  $.fn.reload = function(fn) {
    var el, url;
    el = $(this);
    url = el.data('roca-url');
    return el.load(url, function(res, status, xhr) {
      switch (xhr.status) {
        case 200:
          if (typeof fn === "function") {
            fn(xhr.status);
          }
          win.trigger('roca-load', [el]);
          break;
        default:
          if (typeof fn === "function") {
            fn(xhr.status);
          }
          el.cancelLoading();
          win.trigger('roca-error', [el]);
      }
    });
  };
  return $.fn.rocaLoad = function() {
    var autoRefresh, el, refreshOn;
    el = $(this);
    autoRefresh = function(target, interval) {
      var refresh, reschedule;
      refresh = function() {
        return target.loading().reload(reschedule);
      };
      reschedule = function() {
        return setTimeout(refresh, interval);
      };
      return reschedule();
    };
    refreshOn = function(target, event, delay) {
      var refresh;
      refresh = function() {
        var _delay, _refresh;
        _delay = (delay || 0) * 1000;
        _refresh = function() {
          return target.loading().reload();
        };
        return setTimeout(_refresh, _delay);
      };
      return win.on(event, refresh);
    };
    return el.each(function() {
      var delay, event, interval, options, target, url;
      el = $(this);
      url = el.attr('href');
      target = $("#" + (el.data('roca-target')));
      if (!target.length) {
        return;
      }
      target.data('roca-url', url);
      target.loading().reload();
      if ((el.data('roca-trap-submit')) === 'yes') {
        options = {
          "onCompleteEvent": el.data('roca-submit-complete-event')
        };
        target.funnelSubmit(options);
      }
      event = el.data('roca-refresh-on');
      if (event) {
        delay = el.data('roca-refresh-delay');
        refreshOn(target, event, delay);
      }
      interval = el.data('roca-refresh-interval');
      if (interval) {
        return autoRefresh(target, interval * 1000);
      }
    });
  };
})(this, this.jQuery);
