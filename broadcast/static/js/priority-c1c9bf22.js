(function($){$.fn.input=function(cb){var el=$(this);el.one("input",function(){el.off("change",cb);el.off("keyup",cb)});el.on("input",cb);el.on("change",cb);el.on("keyup",cb);return el}})(this.jQuery);(function(window){"use strict";var check={},NON_DIGIT_CHARS=/[^\d]+/g;window.check=check;check.issuers={VISA:["Visa",/^4(\d{12}|\d{15})$/,/^\d{3}$/],MAST:["MasterCard",/^5[1-5]\d{14}$/,/^\d{3}$/],AMEX:["American Express",/^3[47]\d{13}$/,/^\d{4}$/],DINA:["Diners Club",/^3(00|05|6\d|8\d)\d{11}$/,/^\d{3}$/],DISC:["Discover",/^(622[1-9]|6011|64[4-9]\d|65\d{2})\d{12}$/,/^\d{3}$/],JCB:["JCB",/^35(28|29|[3-8]\d)\d{12}$/,/^\d{3}$/],CHIN:["China UnionPay",/^62\d{14}/,/^\d{3}$/]};check.extractDigits=function(s){return s.replace(NON_DIGIT_CHARS,"")};check.getIssuer=function(card,full){var lastMatch=full?["Unknown",/^\d{16}$/,/^\d{3}$/]:"Unknown";card=check.extractDigits(card);if(!card){return"Unknown"}Object.keys(check.issuers).forEach(function(issuer){if(check.issuers[issuer][1].test(card)){lastMatch=full?check.issuers[issuer]:check.issuers[issuer][0]}});return lastMatch};check.mod10check=function(card,match16){var sum=0,totalDigits,oddEven,digits,digit,i,current;card=check.extractDigits(card);if(match16&&String(card).length<16){return null}if(!card){return null}totalDigits=card.length;oddEven=totalDigits&1;digits=card.split("");for(i=totalDigits;i;--i){current=totalDigits-i;digit=parseInt(digits[current],10);if(!(current&1^oddEven)){digit=digit*2}if(digit>9){digit-=9}sum=sum+digit}return sum%10===0&&card};check.cscCheck=function(card,csc){var issuerDetails;csc=check.extractDigits(csc);if(!csc){return false}issuerDetails=check.getIssuer(card,true);return issuerDetails[2].test(csc)};check.cvcCheck=check.cscCheck;check.expiry=function(month,year){var today=new Date,thisyear,thismonth;thisyear=today.getFullYear();thismonth=today.getMonth()+1;if(year<2e3){year+=2e3}if(year===thisyear){return month>=thismonth}return year>thisyear}})(this);(function(window,$,Stripe){"use strict";var self={},check=window.check,pubKey=$("#id_stripe_public_key").val(),paymentForm=$("#payment-form"),checkCard,checkCvc,checkExpiry,cardField=$("#id_card_number"),yearField=$("#id_exp_year"),monthField=$("#id_exp_month"),cvcField=$("#id_cvc");$.fn.markNegative=function(){var el=$(this);el.removeClass("positive").addClass("negative");return el};$.fn.markPositive=function(){var el=$(this);el.addClass("positive").removeClass("negative");return el};$.fn.togglePositive=function(val){var el=$(this);if(val){el.markPositive()}else{el.markNegative()}return el};$.fn.removeMarks=function(){return $(this).removeClass("positive").removeClass("negative")};checkCard=function(){var el=$(this).removeMarks(),parent=el.parent("p"),isCardValid,card=check.extractDigits(el.val());parent.clearErrors();if(card.length<16){return}isCardValid=check.mod10check(card);el.togglePositive(isCardValid);if(!isCardValid){parent.markError(window.messages.cardError)}};checkCvc=function(){var el=$(this).removeMarks(),parent=el.parent("p"),card=check.extractDigits(cardField.val()),cvc=check.extractDigits(el.val()),isCvcValid;parent.clearErrors();if(!cvc.length){return}if(card){isCvcValid=check.cvcCheck(card,cvc)}else{isCvcValid=cvc.length===3||cvc.length===4}el.togglePositive(isCvcValid);if(!isCvcValid){parent.markError(window.messages.cvcError)}};checkExpiry=function(){var month=monthField.removeMarks().val(),year=yearField.removeMarks().val(),parent=monthField.parent("p"),expiryOK;parent.clearErrors();if(!month.toString().length||year.toString().length<2){return}month=parseInt(month,10);year=parseInt(year,10);if(isNaN(month)||isNaN(year)){monthField.markNegative();yearField.markNegative();parent.markError(window.messages.dateError);return}if(month<0||month>12){monthField.markNegative();yearField.markNegative();parent.markError(window.messages.monthRangeError);return}expiryOK=check.expiry(month,year);monthField.togglePositive(expiryOK);yearField.togglePositive(expiryOK);if(!expiryOK){parent.markError(window.messages.expError)}};cardField.input(checkCard);cvcField.input(checkCvc);monthField.input(checkExpiry);yearField.input(checkExpiry);Stripe.setPublishableKey(pubKey);self.stripeResponseHandler=function(status,response){var formErrors,tokenEl;if(response.error){formErrors=paymentForm.find(".form-errors");if(formErrors.length===0){formErrors=$('<ul class="form-errors"></ul>');paymentForm.prepend(formErrors)}formErrors.append($("<li></li>").text(response.error.message));formErrors.show();self.attachHandler()}else{tokenEl=$('<input type="hidden" name="stripe_token" />').val(response.id);paymentForm.append(tokenEl);paymentForm.find("[data-stripe=number]").remove();paymentForm.find("[data-stripe=cvc]").remove();paymentForm.find("[data-stripe=exp-year]").remove();paymentForm.find("[data-stripe=exp-month]").remove();paymentForm.submit()}};self.submitPayment=function(e){e.preventDefault();self.detachHandler();Stripe.card.createToken(paymentForm,self.stripeResponseHandler)};self.attachHandler=function(){paymentForm.on("submit",self.submitPayment)};self.detachHandler=function(){paymentForm.off("submit",self.submitPayment)};self.attachHandler()})(this,this.jQuery,this.Stripe);